
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Birthday Wish Generator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Manrope:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
      :root {
        --bg-color: #0c0a09;
        --card-bg-color: rgba(15, 23, 42, 1);
      }
      body {
        font-family: 'Manrope', sans-serif;
        background-color: var(--bg-color);
        color: #e2e8f0;
        overflow-x: hidden;
      }
      .font-display {
        font-family: 'Playfair Display', serif;
        line-height: 1.3;
      }

      /* Aurora Background */
      #aurora-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; }
      .aurora-blur { filter: blur(100px); position: absolute; border-radius: 50%; }
      .aurora-1 { background-color: hsla(333, 70%, 55%, 0.3); width: 400px; height: 400px; animation: move1 20s infinite alternate; }
      .aurora-2 { background-color: hsla(282, 82%, 54%, 0.2); width: 500px; height: 500px; animation: move2 25s infinite alternate; }
      .aurora-3 { background-color: hsla(210, 89%, 60%, 0.2); width: 350px; height: 350px; animation: move3 18s infinite alternate; }
      .aurora-4 { background-color: hsla(35, 90%, 60%, 0.2); width: 450px; height: 450px; animation: move4 22s infinite alternate; }
      @keyframes move1 { from { transform: translate(-20%, -10%) rotate(0deg); } to { transform: translate(20%, 10%) rotate(30deg); } }
      @keyframes move2 { from { transform: translate(10%, 20%) scale(1); } to { transform: translate(-10%, -20%) scale(1.2); } }
      @keyframes move3 { from { transform: translate(-15%, 15%) rotate(45deg); } to { transform: translate(15%, -15%) rotate(-45deg); } }
      @keyframes move4 { from { transform: translate(20%, -20%); } to { transform: translate(-20%, 20%); } }

      /* Glassmorphism Card */
      .card {
        background-color: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      /* UI Elements */
      .text-gradient {
        background: linear-gradient(to right, #f9a8d4, #ffffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
      }
      .btn-primary {
        background: linear-gradient(to right, #ec4899, #ef4444);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 0 30px rgba(236, 72, 153, 0.8);
      }
      .btn-primary:active { transform: translateY(0px) scale(1); }
      
      /* Bento Grid */
      .bento-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
      .bento-item { 
        background-color: rgba(255, 255, 255, 0.05); 
        border-radius: 1rem; 
        padding: 1.5rem; 
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .bento-item:hover { transform: translateY(-5px); }
      .bento-item.col-span-2 { grid-column: span 2 / span 2; }

      /* Photo Gallery */
      .photo-gallery { -ms-overflow-style: none; scrollbar-width: none; }
      .photo-gallery::-webkit-scrollbar { display: none; }
      .polaroid {
        background: white; padding: 1rem 1rem 3.5rem 1rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        transition: transform 0.3s ease; transform-style: preserve-3d;
      }
      .polaroid figcaption {
        position: absolute; bottom: 1rem; left: 1rem; right: 1rem;
        text-align: center; color: #333;
      }
      #photo-gallery-wrapper::before,
      #photo-gallery-wrapper::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        width: 3rem;
        z-index: 2;
        pointer-events: none;
      }
      #photo-gallery-wrapper::before {
        left: 0;
        background: linear-gradient(to right, var(--card-bg-color), transparent);
      }
      #photo-gallery-wrapper::after {
        right: 0;
        background: linear-gradient(to left, var(--card-bg-color), transparent);
      }
      
      /* Video Player */
      .aspect-video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%; /* 16:9 Aspect Ratio */
      }
      .aspect-video-container iframe,
      .aspect-video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.2.4",
    "react-dom/client": "https://esm.sh/react-dom@19.2.4/client",
    "@google/genai": "https://esm.sh/@google/genai@1.41.0",
    "three": "https://esm.sh/three@0.182.0",
    "gsap": "https://esm.sh/gsap@3.14.2",
    "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
<!-- Babel for JSX & TS Transpilation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
  <body>
    <div id="root"></div>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";
      import * as THREE from 'three';
      import gsap from 'gsap';
      import confetti from 'canvas-confetti';

      // --- Gemini Service ---
      const generateBirthdayContent = async (name, relationship, memories) => {
          if (!process.env.API_KEY) {
              throw new Error("API_KEY environment variable not set");
          }
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
          const prompt = `
              Based on the following information, generate heartfelt and romantic content for a special birthday website.
              - Recipient's Name: ${name}
              - My Relationship with them: ${relationship}
              - Key Memories/Feelings: "${memories}"

              The tone should be modern, deeply personal, and emotional. Adhere to the requested JSON schema. 
              The letter should be a longer, heartfelt message (2-3 paragraphs) that expands on the feelings and memories provided.
              The final message should be a short, impactful sign-off.
          `;
          try {
              const response = await ai.models.generateContent({
                  model: 'gemini-3-pro-preview',
                  contents: prompt,
                  config: {
                      responseMimeType: "application/json",
                      responseSchema: {
                          type: Type.OBJECT,
                          properties: {
                              welcomeMessage: { type: Type.STRING, description: "A short, sweet welcome message. e.g., 'I built a little world for you...'" },
                              birthdayMessage: { type: Type.STRING, description: "A message wishing them a happy birthday. e.g., 'Another year of you making the world brighter...'" },
                              bentoItems: {
                                  type: Type.ARRAY,
                                  description: "Generate 3 to 5 distinct, positive attributes or 'reasons I adore you'.",
                                  items: {
                                      type: Type.OBJECT,
                                      properties: {
                                          icon: { type: Type.STRING, description: "A single, relevant emoji for the title." },
                                          title: { type: Type.STRING, description: "A short title for the attribute (e.g., 'Your Radiant Spirit')." },
                                          text: { type: Type.STRING, description: "A short sentence elaborating on the attribute." },
                                      },
                                      required: ["icon", "title", "text"]
                                  }
                              },
                              wishMessage: { type: Type.STRING, description: "A forward-looking wish for their year ahead. e.g., 'May the next year bring you all the love...'" },
                              letter: { type: Type.STRING, description: "A heartfelt letter to the recipient, 2-3 paragraphs long." },
                              finalMessage: { type: Type.STRING, description: `A short, final birthday sign-off. e.g., 'Happy Birthday, ${name}! â¤ï¸'"` },
                          },
                          required: ["welcomeMessage", "birthdayMessage", "bentoItems", "wishMessage", "letter", "finalMessage"]
                      },
                  }
              });
              const jsonText = response.text?.trim();
              if (jsonText) {
                  return JSON.parse(jsonText);
              } else {
                  throw new Error("AI returned an empty response.");
              }
          } catch (error) {
              console.error("Error calling Gemini API:", error);
              throw new Error("Failed to generate content from AI service. Please check your inputs.");
          }
      };

      // --- SetupForm Component ---
      const SetupForm = ({ onSubmit, initialData }) => {
          const defaultPhotos = [
              { url: 'https://i.ibb.co/6Z6XgCg/crush.webp', caption: 'Our favorite memory.' },
              { url: 'https://images.unsplash.com/photo-1524250502761-1ac6f2e30d43?q=80&w=1888', caption: 'That day at the cafe.' }
          ];
          const defaultVideos = [
              { url: 'https://www.youtube.com/watch?v=LXb3EKWsInQ', caption: 'A Special Message' }
          ];
          const defaultPlaylist = [
              { url: 'https://www.youtube.com/watch?v=jfKfPfyJRdk', title: 'Lofi Girl - beats to relax/study to' },
              { url: 'https://www.youtube.com/watch?v=rUxyKA_-grg', title: 'a playlist of songs that make you feel like the main character' }
          ];

          const reconstructUrl = (item, type) => {
              if (item.type === 'youtube') return `https://www.youtube.com/watch?v=${item.id}`;
              if (item.type === 'googledrive') return `https://drive.google.com/file/d/${item.id}/view`;
              if (item.type === 'data') return item.url;
              return '';
          };
          
          const [relationship, setRelationship] = useState(initialData?.relationship || '');
          const [memories, setMemories] = useState(initialData?.memories || '');
          const [recipientName, setRecipientName] = useState(initialData?.recipientName || 'Beautiful');
          const [welcomeMessage, setWelcomeMessage] = useState(initialData?.welcomeMessage || "I built a little world for you...");
          const [birthdayMessage, setBirthdayMessage] = useState(initialData?.birthdayMessage || "Another year of you making the world brighter.");
          const [bentoItems, setBentoItems] = useState(initialData?.bentoItems || [
              { icon: 'âœ¨', title: 'Your Unmatched Kindness', text: 'The genuine warmth you show to everyone is something truly rare and beautiful.' },
              { icon: 'ðŸ˜Š', title: 'That Smile', text: "It's a work of art." },
              { icon: 'ðŸŒŸ', title: 'Your Radiant Spirit', text: 'Your passion for life is infectious.' }
          ]);
          const [galleryTitle, setGalleryTitle] = useState(initialData?.galleryTitle || "A Gallery of Memories");
          const [photos, setPhotos] = useState(initialData?.photos || defaultPhotos);
          const [videos, setVideos] = useState(initialData?.videos?.map(v => ({ url: reconstructUrl(v, 'video'), caption: v.caption })) || defaultVideos);
          const [playlist, setPlaylist] = useState(initialData?.playlist?.map(s => ({ url: reconstructUrl(s, 'youtube'), title: s.title })) || defaultPlaylist);
          const [galleryClosing, setGalleryClosing] = useState(initialData?.galleryClosing || "Every moment with you feels like a scene...");
          const [letter, setLetter] = useState(initialData?.letter || "My Dearest Beautiful,\n\nOn your special day, I find myself reflecting on all the moments we've shared, big and small. Each one is a treasure, a testament to the incredible person you are. From your infectious laugh to the quiet way you listen, you make every day brighter.\n\nI hope the year ahead brings you as much joy and light as you bring to everyone around you. May all your dreams take flight.");
          const [wishMessage, setWishMessage] = useState(initialData?.wishMessage || "May the next year bring you all the love...");
          const [wishDescription, setWishDescription] = useState(initialData?.wishDescription || "This is a space to send your hopes and dreams out into the universe. What are you wishing for on this special day?");
          const [finalMessage, setFinalMessage] = useState(initialData?.finalMessage || "Happy Birthday! â¤ï¸");
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState('');

          const getYouTubeId = (url) => {
              const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
              const match = url.match(regExp);
              return (match && match[2].length === 11) ? { type: 'youtube', id: match[2] } : null;
          };

          const processVideoUrl = (url) => {
              if (url.startsWith('data:video/')) return { type: 'data', url: url };
              const ytMatch = getYouTubeId(url);
              if (ytMatch) return ytMatch;
              const gdRegExp = /drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/;
              const gdMatch = url.match(gdRegExp);
              if (gdMatch) return { type: 'googledrive', id: gdMatch[1] };
              return null;
          };

          const handleAddPhoto = () => setPhotos([...photos, { url: '', caption: '' }]);
          const handlePhotoChange = (index, field, value) => setPhotos(photos.map((p, i) => i === index ? { ...p, [field]: value } : p));
          const handleRemovePhoto = (index) => setPhotos(photos.filter((_, i) => i !== index));
          const handlePhotoFileChange = (index, e) => {
              const file = e.target.files[0];
              if (file && file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = (upload) => handlePhotoChange(index, 'url', upload.target.result);
                  reader.readAsDataURL(file);
              }
          };
          
          const handleAddVideo = () => setVideos([...videos, { url: '', caption: '' }]);
          const handleVideoChange = (index, field, value) => setVideos(videos.map((v, i) => i === index ? { ...v, [field]: value } : v));
          const handleRemoveVideo = (index) => setVideos(videos.filter((_, i) => i !== index));
          const handleVideoFileChange = (index, e) => {
              const file = e.target.files[0];
              if (file && file.type.startsWith('video/')) {
                  if (file.size > 5 * 1024 * 1024) { // 5MB limit
                      setError('Video file is too large. Please keep it under 5MB or use a YouTube/Google Drive link.');
                      return;
                  }
                  setError('');
                  const reader = new FileReader();
                  reader.onload = (upload) => handleVideoChange(index, 'url', upload.target.result);
                  reader.readAsDataURL(file);
              }
          };

          const handleAddBentoItem = () => setBentoItems([...bentoItems, { icon: 'ðŸ’–', title: '', text: '' }]);
          const handleBentoItemChange = (index, field, value) => setBentoItems(bentoItems.map((item, i) => i === index ? { ...item, [field]: value } : item));
          const handleRemoveBentoItem = (index) => setBentoItems(bentoItems.filter((_, i) => i !== index));
          
          const handleAddSong = () => setPlaylist([...playlist, { url: '', title: '' }]);
          const handleSongChange = (index, field, value) => setPlaylist(playlist.map((s, i) => (i === index ? { ...s, [field]: value } : s)));
          const handleRemoveSong = (index) => setPlaylist(playlist.filter((_, i) => i !== index));

          const handleGenerateContent = async () => {
              if (!recipientName || !relationship || !memories) {
                  setError('Please fill in Name, Relationship, and Memories to generate content.');
                  return;
              }
              setIsLoading(true);
              setError('');
              try {
                  const content = await generateBirthdayContent(recipientName, relationship, memories);
                  setWelcomeMessage(content.welcomeMessage);
                  setBirthdayMessage(content.birthdayMessage);
                  setBentoItems(content.bentoItems);
                  setWishMessage(content.wishMessage);
                  setLetter(content.letter);
                  setFinalMessage(content.finalMessage);
              } catch (err) {
                  setError(err.message);
              } finally {
                  setIsLoading(false);
              }
          };

          const getGoogleDriveImageUrl = (url) => {
              if (url.startsWith('data:')) return url;
              const gdRegExp = /drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/;
              const match = url.match(gdRegExp);
              if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
              return url;
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              setError('');
              const playlistWithIds = playlist.map(song => ({ ...song, ...getYouTubeId(song.url) }));
              if (playlistWithIds.some(song => !song.id)) {
                  setError('Please enter a valid YouTube URL for all songs in the playlist.');
                  return;
              }

              const videosWithData = videos.map(video => ({ ...video, processed: processVideoUrl(video.url) }));
              if (videosWithData.some(video => !video.processed)) {
                  setError('Please enter a valid YouTube/Google Drive URL for all videos, or upload a small video file.');
                  return;
              }
              const finalVideos = videosWithData.map(v => ({ caption: v.caption, ...v.processed }));
              
              const processedPhotos = photos.map(photo => ({ ...photo, url: getGoogleDriveImageUrl(photo.url) }));
              if (processedPhotos.some(p => !p.url || !p.caption)) {
                  setError('Please ensure all photo fields are filled out.');
                  return;
              }

              if (bentoItems.some(item => !item.icon || !item.title || !item.text)) {
                  setError('Please ensure all "Adore About You" fields are filled out.');
                  return;
              }
              onSubmit({ recipientName, welcomeMessage, birthdayMessage, bentoItems, galleryTitle, photos: processedPhotos, videos: finalVideos, galleryClosing, wishMessage, wishDescription, finalMessage, playlist: playlistWithIds.map(({title, type, id}) => ({title, type, id})), letter });
          };

          const inputStyles = "w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-400 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300 shadow-lg";
          const labelStyles = "block mb-2 text-sm font-bold text-pink-300";

          return (
              <div className="min-h-screen w-full flex flex-col items-center justify-center p-4 text-slate-200">
                  <div id="aurora-bg"><div className="aurora-blur aurora-1"></div><div className="aurora-blur aurora-2"></div><div className="aurora-blur aurora-3"></div><div className="aurora-blur aurora-4"></div></div>
                  <form onSubmit={handleSubmit} className="w-full max-w-3xl mx-auto card p-8 space-y-6 my-16">
                      <div className="text-center">
                          <h1 className="text-4xl font-display text-gradient">Birthday Site Generator</h1>
                          <p className="text-pink-300 mt-2">Create a magical gift for someone special.</p>
                      </div>
                      <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700" open>
                          <summary className="font-bold text-lg text-white cursor-pointer">Step 1: AI Content Generation</summary>
                          <div className="grid md:grid-cols-2 gap-6 mt-4">
                              <div><label htmlFor="recipientName" className={labelStyles}>To (Name):</label><input type="text" id="recipientName" value={recipientName} onChange={e => setRecipientName(e.target.value)} className={inputStyles} placeholder="e.g., Alex" /></div>
                              <div><label htmlFor="relationship" className={labelStyles}>Your Relationship:</label><input type="text" id="relationship" value={relationship} onChange={e => setRelationship(e.target.value)} className={inputStyles} placeholder="e.g., My amazing girlfriend" /></div>
                              <div className="md:col-span-2"><label htmlFor="memories" className={labelStyles}>Memories & Feelings for AI:</label><textarea id="memories" value={memories} onChange={e => setMemories(e.target.value)} className={`${inputStyles} h-20`} placeholder="A happy memory, what you admire..."></textarea></div>
                          </div>
                          <button type="button" onClick={handleGenerateContent} disabled={isLoading} className="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 disabled:opacity-50 flex items-center justify-center gap-2">{isLoading ? 'Generating...' : 'âœ¨ Use AI to Write Messages'}</button>
                      </details>
                      <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                          <summary className="font-bold text-lg text-white cursor-pointer">Step 2: Customize Main Messages</summary>
                          <div className="space-y-4 mt-4">
                              <div><label className={labelStyles}>Welcome Message</label><textarea value={welcomeMessage} onChange={e => setWelcomeMessage(e.target.value)} className={inputStyles} /></div>
                              <div><label className={labelStyles}>Birthday Message</label><textarea value={birthdayMessage} onChange={e => setBirthdayMessage(e.target.value)} className={inputStyles} /></div>
                              <div><label className={labelStyles}>Wish For Them</label><textarea value={wishMessage} onChange={e => setWishMessage(e.target.value)} className={inputStyles} /></div>
                              <div><label className={labelStyles}>Final Message</label><input type="text" value={finalMessage} onChange={e => setFinalMessage(e.target.value)} className={inputStyles} /></div>
                          </div>
                      </details>
                      <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                          <summary className="font-bold text-lg text-white cursor-pointer">Step 3: Customize "Adore About You" Section</summary>
                          <div className="space-y-4 mt-4">
                              {bentoItems.map((item, index) => (
                                  <div key={index} className="grid grid-cols-[auto_1fr_1fr_auto] items-end gap-2 p-2 rounded-md bg-slate-800/50">
                                      <div><label className={labelStyles}>Icon</label><input type="text" value={item.icon} onChange={e => handleBentoItemChange(index, 'icon', e.target.value)} className={`${inputStyles} w-16 text-center`} /></div>
                                      <div className="flex-grow"><label className={labelStyles}>Title</label><input type="text" value={item.title} onChange={e => handleBentoItemChange(index, 'title', e.target.value)} className={inputStyles} /></div>
                                      <div className="flex-grow"><label className={labelStyles}>Text</label><input type="text" value={item.text} onChange={e => handleBentoItemChange(index, 'text', e.target.value)} className={inputStyles} /></div>
                                      <button type="button" onClick={() => handleRemoveBentoItem(index)} className="bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg h-12 w-12">-</button>
                                  </div>
                              ))}
                          </div>
                          <button type="button" onClick={handleAddBentoItem} className="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">+</button>
                      </details>
                      <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                          <summary className="font-bold text-lg text-white cursor-pointer">Step 4: Customize Photo Gallery</summary>
                          <p className="text-sm text-sky-300 bg-sky-900/50 p-3 rounded-lg mt-2 border border-sky-700"><i className="fas fa-info-circle mr-2"></i><strong>Pro Tip:</strong> To make sure your website works on any device, upload photos to a service like <a href="https://imgur.com/upload" target="_blank" rel="noopener noreferrer" className="underline font-bold">Imgur</a> or use a shareable Google Drive link, then paste the URL below.</p>
                          <div className="space-y-4 mt-4">
                              {photos.map((photo, index) => (
                                  <div key={index} className="p-4 rounded-lg bg-slate-800/50 border border-slate-700 flex items-start gap-4">
                                      <img src={photo.url || 'https://via.placeholder.com/150/111827/808080?Text=No+Image'} alt="Preview" className="w-24 h-24 object-cover rounded-lg flex-shrink-0" />
                                      <div className="flex-grow space-y-3">
                                          <div className="flex items-end gap-2">
                                              <div className="flex-grow"><label htmlFor={`photo-url-${index}`} className={labelStyles}>Photo #{index + 1} URL</label><input id={`photo-url-${index}`} type="text" value={photo.url.startsWith('data:') ? '' : photo.url} onChange={e => handlePhotoChange(index, 'url', e.target.value)} className={inputStyles} placeholder={photo.url.startsWith('data:') ? 'Custom image uploaded' : 'Paste URL or Upload'} /></div>
                                              <input type="file" id={`file-upload-${index}`} accept="image/*" onChange={(e) => handlePhotoFileChange(index, e)} className="hidden" /><label htmlFor={`file-upload-${index}`} className="flex-shrink-0 h-12 text-center cursor-pointer bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Upload</label>
                                          </div>
                                          <div className="flex items-center gap-2"><label htmlFor={`photo-caption-${index}`} className="sr-only">Caption</label><input id={`photo-caption-${index}`} type="text" value={photo.caption} onChange={e => handlePhotoChange(index, 'caption', e.target.value)} className={inputStyles} placeholder="A short caption" /><button type="button" onClick={() => handleRemovePhoto(index)} className="bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg h-12 w-12 flex-shrink-0">-</button></div>
                                           {photo.url.startsWith('data:') && (
                                            <div className="text-xs text-amber-400 bg-amber-900/50 p-2 rounded-md border border-amber-800">
                                                <i className="fas fa-exclamation-triangle mr-1"></i>
                                                This uploaded file may not work when sharing the link. Use a URL for best results.
                                            </div>
                                          )}
                                      </div>
                                  </div>
                              ))}
                          </div>
                          <button type="button" onClick={handleAddPhoto} className="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">+</button>
                      </details>
                       <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                          <summary className="font-bold text-lg text-white cursor-pointer">Step 5: Customize Video Messages</summary>
                          <p className="text-sm text-sky-300 bg-sky-900/50 p-3 rounded-lg mt-2 border border-sky-700"><i className="fas fa-info-circle mr-2"></i><strong>Pro Tip:</strong> For best results, use YouTube or Google Drive links. Uploading video files directly is limited to 5MB and may not work when sharing the website link.</p>
                          <div className="space-y-4 mt-4">
                              {videos.map((video, index) => (
                                  <div key={index} className="p-4 rounded-lg bg-slate-800/50 border border-slate-700 flex items-start gap-4">
                                      <video src={video.url.startsWith('data:video') ? video.url : ''} controls className="w-24 h-24 object-cover rounded-lg flex-shrink-0 bg-slate-900" />
                                      <div className="flex-grow space-y-3">
                                          <div className="flex items-end gap-2">
                                              <div className="flex-grow"><label htmlFor={`video-url-${index}`} className={labelStyles}>Video #{index + 1} URL</label><input id={`video-url-${index}`} type="text" value={video.url.startsWith('data:') ? '' : video.url} onChange={e => handleVideoChange(index, 'url', e.target.value)} className={inputStyles} placeholder={video.url.startsWith('data:') ? 'Custom video uploaded' : 'Paste URL or Upload'} /></div>
                                              <input type="file" id={`video-file-upload-${index}`} accept="video/*" onChange={(e) => handleVideoFileChange(index, e)} className="hidden" /><label htmlFor={`video-file-upload-${index}`} className="flex-shrink-0 h-12 text-center cursor-pointer bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Upload</label>
                                          </div>
                                          <div className="flex items-center gap-2"><label htmlFor={`video-caption-${index}`} className="sr-only">Caption</label><input id={`video-caption-${index}`} type="text" value={video.caption} onChange={e => handleVideoChange(index, 'caption', e.target.value)} className={inputStyles} placeholder="A short caption" /><button type="button" onClick={() => handleRemoveVideo(index)} className="bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg h-12 w-12 flex-shrink-0">-</button></div>
                                           {video.url.startsWith('data:') && (
                                            <div className="text-xs text-amber-400 bg-amber-900/50 p-2 rounded-md border border-amber-800">
                                                <i className="fas fa-exclamation-triangle mr-1"></i>
                                                Uploaded video may not work when link is shared. Use a YouTube/Drive link instead.
                                            </div>
                                          )}
                                      </div>
                                  </div>
                              ))}
                          </div>
                          <button type="button" onClick={handleAddVideo} className="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">+</button>
                      </details>
                      <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                          <summary className="font-bold text-lg text-white cursor-pointer">Step 6: Customize The Letter</summary>
                          <div className="space-y-4 mt-4">
                              <div><label className={labelStyles}>Your Letter</label><textarea value={letter} onChange={e => setLetter(e.target.value)} className={`${inputStyles} h-48`} /></div>
                          </div>
                      </details>
                      <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                          <summary className="font-bold text-lg text-white cursor-pointer">Step 7: Customize Playlist</summary>
                          <div className="space-y-4 mt-4">
                              {playlist.map((song, index) => (
                                  <div key={index} className="grid grid-cols-1 md:grid-cols-[1fr_1fr_auto] items-end gap-4">
                                      <div><label className={labelStyles}>Song #{index + 1} URL</label><input type="url" value={song.url} onChange={e => handleSongChange(index, 'url', e.target.value)} className={inputStyles} placeholder="https://youtube.com/..." /></div>
                                      <div><label className={labelStyles}>Title</label><input type="text" value={song.title} onChange={e => handleSongChange(index, 'title', e.target.value)} className={inputStyles} placeholder="Song Title" /></div>
                                      <button type="button" onClick={() => handleRemoveSong(index)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-3 rounded-lg h-12 w-full md:w-auto">-</button>
                                  </div>
                              ))}
                          </div>
                          <button type="button" onClick={handleAddSong} className="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">+</button>
                      </details>
                      <details className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                        <summary className="font-bold text-lg text-white cursor-pointer">Step 8: Customize Wish Page</summary>
                        <div className="space-y-4 mt-4">
                            <div>
                                <label className={labelStyles}>Wish Page Description</label>
                                <textarea value={wishDescription} onChange={e => setWishDescription(e.target.value)} className={`${inputStyles} h-24`} />
                            </div>
                        </div>
                      </details>
                      {error && <div className="bg-red-900/50 text-red-300 p-3 rounded-lg text-center">{error}</div>}
                      <button type="submit" className="w-full btn-primary text-white font-bold py-4 px-4 rounded-lg text-xl">
                          Create Birthday Website
                      </button>
                  </form>
              </div>
          );
      };

      // --- BirthdayWebsite Component ---
      const BirthdayWebsite = ({ config, onStartOver }) => {
          const canvasRef = useRef(null);
          const objectsRef = useRef([]);
          const sceneRef = useRef(null);
          const launchedStarsRef = useRef(null);
          const starFieldRef = useRef(null);
          const animationFrameId = useRef(null);
          const [currentStep, setCurrentStep] = useState(1);
          const [isMusicPlaying, setIsMusicPlaying] = useState(false);
          const [currentSongIndex, setCurrentSongIndex] = useState(null);
          const [isPlayerReady, setIsPlayerReady] = useState(false);
          const playerRef = useRef(null);
          const [wishes, setWishes] = useState([]);
          const [newWish, setNewWish] = useState('');
          const [copySuccess, setCopySuccess] = useState('');
          const [isWishLaunched, setIsWishLaunched] = useState(false);
          const [launchedWishText, setLaunchedWishText] = useState('');

          const TOTAL_STEPS = 9;
          
          useEffect(() => {
            const storedWishes = localStorage.getItem(`birthdayWishes_${config.recipientName}`);
            if (storedWishes) setWishes(JSON.parse(storedWishes));
          }, [config.recipientName]);

          useEffect(() => {
            localStorage.setItem(`birthdayWishes_${config.recipientName}`, JSON.stringify(wishes));
          }, [wishes, config.recipientName]);
          
          const goToStep = (stepNumber) => {
              if (currentStep === stepNumber) return;
              const currentStepEl = document.getElementById(`step-${currentStep}`);
              if (currentStepEl) {
                  gsap.to(currentStepEl, { 
                      opacity: 0, 
                      scale: 0.9, 
                      duration: 0.4, 
                      ease: 'power3.in',
                      onComplete: () => {
                          setCurrentStep(stepNumber);
                      }
                  });
              } else {
                  setCurrentStep(stepNumber);
              }
          };

          useEffect(() => {
              const stepEl = document.getElementById(`step-${currentStep}`);
              if (stepEl) {
                  gsap.fromTo(stepEl, 
                      { opacity: 0, scale: 1.1 }, 
                      { 
                          opacity: 1, 
                          scale: 1, 
                          duration: 0.6, 
                          ease: 'power3.out',
                          delay: currentStep === 1 ? 0.5 : 0 
                      }
                  );
              }
          }, [currentStep]);

          const handleAddWish = () => {
            if (newWish.trim()) {
              setWishes([...wishes, newWish.trim()]);
              setNewWish('');
            }
          };

          const handleRemoveWish = (indexToRemove) => {
            setWishes(wishes.filter((_, index) => index !== indexToRemove));
          };

          const handleCopyWishes = () => {
              navigator.clipboard.writeText(wishes.join('\n')).then(() => {
                  setCopySuccess('Copied to clipboard!');
                  setTimeout(() => setCopySuccess(''), 2000);
              }, () => {
                  setCopySuccess('Failed to copy.');
                  setTimeout(() => setCopySuccess(''), 2000);
              });
          };

          useEffect(() => {
              const initPlayer = () => {
                  if (playerRef.current) playerRef.current.destroy();
                  const firstVideoId = config.playlist?.find(p => p.type === 'youtube')?.id;
                  if (!firstVideoId) return;

                  playerRef.current = new window.YT.Player('youtube-player', {
                      height: '0', width: '0', videoId: firstVideoId,
                      playerVars: { autoplay: 0, controls: 0, loop: 1, playlist: firstVideoId },
                      events: { 
                          'onReady': (event) => { event.target.setVolume(30); setIsPlayerReady(true); },
                          'onStateChange': (event) => {
                              if (event.data === window.YT.PlayerState.PLAYING) setIsMusicPlaying(true);
                              else if (event.data === window.YT.PlayerState.PAUSED || event.data === window.YT.PlayerState.ENDED) setIsMusicPlaying(false);
                          }
                      }
                  });
              };
              if (window.YT?.Player) { initPlayer(); } else { window.onYouTubeIframeAPIReady = initPlayer; }

              const canvas = canvasRef.current;
              if (!canvas) return;
              sceneRef.current = new THREE.Scene();
              const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
              camera.position.z = 5;
              const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
              renderer.setSize(window.innerWidth, window.innerHeight);
              renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
              sceneRef.current.add(new THREE.AmbientLight(0xffffff, 1.5));
              const dirLight = new THREE.DirectionalLight(0xffffff, 2);
              dirLight.position.set(5, 5, 5);
              sceneRef.current.add(dirLight);
              
              const heartShape = new THREE.Shape().moveTo(25, 25).bezierCurveTo(25, 25, 20, 0, 0, 0).bezierCurveTo(-30, 0, -30, 35, -30, 35).bezierCurveTo(-30, 55, -10, 77, 25, 95).bezierCurveTo(60, 77, 80, 55, 80, 35).bezierCurveTo(80, 35, 80, 0, 50, 0).bezierCurveTo(35, 0, 25, 25, 25, 25);
              const heartGeom = new THREE.ExtrudeGeometry(heartShape, { depth: 8, bevelEnabled: true, bevelSegments: 2, steps: 2, bevelSize: 1, bevelThickness: 1 }).scale(0.02, 0.02, 0.02).center();
              const heartMaterial = new THREE.MeshStandardMaterial({ color: 0xec4899, roughness: 0.3, metalness: 0.6, transparent: true });
              
              objectsRef.current = [];
              for (let i = 0; i < 25; i++) {
                  const x = (Math.random() - 0.5) * 20; const y = (Math.random() - 0.5) * 20; const z = (Math.random() - 0.5) * 10;
                  const userData = { sinOffset: Math.random() * Math.PI * 2, speed: Math.random() * 0.3 + 0.1, initialPosition: new THREE.Vector3(x, y, z) };
                  let obj;
                  const rand = Math.random();

                  if (rand < 0.5) { // Heart
                      obj = new THREE.Mesh(heartGeom, heartMaterial.clone());
                      obj.isGroup = false;
                  } else { // Gift
                      const giftGroup = new THREE.Group();
                      const giftColors = [0xa78bfa, 0x7dd3fc, 0x60a5fa, 0xfde047]; const ribbonColor = 0xf1f5f9;
                      const boxMaterial = new THREE.MeshStandardMaterial({ color: giftColors[Math.floor(Math.random() * giftColors.length)], roughness: 0.3, metalness: 0.6, transparent: true });
                      const ribbonMaterial = new THREE.MeshStandardMaterial({ color: ribbonColor, roughness: 0.3, metalness: 0.6, transparent: true });
                      const boxMesh = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), boxMaterial);
                      const ribbon1Mesh = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.3, 1.6), ribbonMaterial);
                      const ribbon2Mesh = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.6, 1.6), ribbonMaterial);
                      giftGroup.add(boxMesh, ribbon1Mesh, ribbon2Mesh); obj = giftGroup; obj.isGroup = true;
                  }

                  obj.position.set(x, y, z); obj.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
                  obj.scale.setScalar(Math.random() * 0.5 + 0.3); obj.userData = userData; sceneRef.current.add(obj); objectsRef.current.push(obj);
              }
              
              const starVertices = [];
              for (let i = 0; i < 1500; i++) {
                  starVertices.push((Math.random() - 0.5) * 100, (Math.random() - 0.5) * 100, (Math.random() - 0.5) * 100);
              }
              const starGeometry = new THREE.BufferGeometry();
              starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
              const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.8 });
              starFieldRef.current = new THREE.Points(starGeometry, starMaterial);
              sceneRef.current.add(starFieldRef.current);

              const animate = () => {
                  animationFrameId.current = requestAnimationFrame(animate);
                  const time = Date.now() * 0.0005;
                  objectsRef.current.forEach(obj => { obj.rotation.y += Math.sin(time * obj.userData.speed + obj.userData.sinOffset) * 0.01; });
                  
                  if (starFieldRef.current) {
                      const positions = starFieldRef.current.geometry.attributes.position.array;
                      for (let i = 0; i < positions.length; i += 3) {
                          positions[i + 2] += 0.1; 
                          if (positions[i + 2] > camera.position.z) {
                              positions[i + 2] = -50;
                          }
                      }
                      starFieldRef.current.geometry.attributes.position.needsUpdate = true;
                  }

                  renderer.render(sceneRef.current, camera);
              };
              animate();
              const handleResize = () => {
                  camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
              };
              window.addEventListener('resize', handleResize);
              return () => {
                  window.removeEventListener('resize', handleResize);
                  if (animationFrameId.current) cancelAnimationFrame(animationFrameId.current);
                  playerRef.current?.destroy();
              };
          }, [config.playlist]);
          
          const handlePlaySong = (index) => {
              if (!isPlayerReady || !playerRef.current) return;
              if (index === currentSongIndex) {
                  const playerState = playerRef.current.getPlayerState();
                  if (playerState === 1) playerRef.current.pauseVideo();
                  else playerRef.current.playVideo();
              } else {
                  const videoId = config.playlist[index].id;
                  playerRef.current.loadVideoById(videoId);
                  setCurrentSongIndex(index);
              }
          };

          const toggleMusic = () => {
              if (!isPlayerReady || !playerRef.current || typeof playerRef.current.getPlayerState !== 'function') return;
              if (currentSongIndex === null) setCurrentSongIndex(0);
              const playerState = playerRef.current.getPlayerState();
              if (playerState === 1) { playerRef.current.pauseVideo(); } else { playerRef.current.playVideo(); }
          };
          const handleBegin = () => {
              if (isPlayerReady && playerRef.current?.playVideo) {
                  setCurrentSongIndex(0);
                  playerRef.current.playVideo();
              }
              goToStep(2);
          };
          
          const handleLaunchWish = () => {
            const lastWish = wishes.length > 0 ? wishes[wishes.length - 1] : "For all your dreams to come true.";
            setLaunchedWishText(lastWish);
            setIsWishLaunched(true);

            const scene = sceneRef.current;
            if (!scene) return;

            objectsRef.current.forEach(obj => {
                gsap.to(obj.position, {
                    x: (Math.random() - 0.5) * 30, y: (Math.random() - 0.5) * 30, z: Math.random() * -20,
                    duration: 2.5, ease: 'power3.in'
                });

                if (obj.isGroup) {
                    obj.children.forEach(child => {
                        if (child.material) gsap.to(child.material, { opacity: 0, duration: 2.5, ease: 'power3.in' });
                    });
                } else {
                    gsap.to(obj.material, { opacity: 0, duration: 2.5, ease: 'power3.in' });
                }
            });

            if (launchedStarsRef.current) scene.remove(launchedStarsRef.current);
            const starVertices = [];
            for (let i = 0; i < 10000; i++) {
                starVertices.push((Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200);
            }
            const starGeometry = new THREE.BufferGeometry();
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0 });
            launchedStarsRef.current = new THREE.Points(starGeometry, starMaterial);
            scene.add(launchedStarsRef.current);

            const tl = gsap.timeline();
            tl.to('#wish-list-ui', { opacity: 0, duration: 1, ease: 'power2.in' })
              .to(starFieldRef.current.material, { opacity: 0, duration: 1, ease: 'power2.in'}, '<')
              .to(launchedStarsRef.current.material, { opacity: 1, duration: 3, ease: 'power2.out' }, "-=0.5")
              .fromTo('#launched-wish-text', { opacity: 0, scale: 0.5, y: 0 }, { opacity: 1, scale: 1.2, y: -50, duration: 3, ease: 'back.out(1.7)' }, "-=2.5")
              .to('#launched-wish-text', { opacity: 0, scale: 0.1, y: -200, duration: 2, ease: 'power3.in' }, "+=1")
              .fromTo('#wish-sent-confirmation', { opacity: 0 }, { opacity: 1, duration: 1.5 }, ">-0.5");
          };

          const handleCelebration = () => {
              const end = Date.now() + (5 * 1000);
              const colors = ['#ec4899', '#f87171', '#a78bfa', '#ffffff'];

              (function frame() {
                  confetti({
                      particleCount: 2,
                      angle: 60,
                      spread: 55,
                      origin: { x: 0 },
                      colors: colors
                  });
                   confetti({
                      particleCount: 2,
                      angle: 120,
                      spread: 55,
                      origin: { x: 1 },
                      colors: colors
                  });
                  
                  if (Date.now() < end) {
                      requestAnimationFrame(frame);
                  }
              }());
              
              const duration = 5 * 1000;
              const animationEnd = Date.now() + duration;
              let skew = 1;
              function randomInRange(min, max) { return Math.random() * (max - min) + min; }
              
              (function frame() {
                const timeLeft = animationEnd - Date.now();
                const ticks = Math.max(200, 500 * (timeLeft / duration));
                skew = Math.max(0.8, skew - 0.001);

                confetti({
                  particleCount: 1,
                  startVelocity: 0,
                  ticks: ticks,
                  origin: {
                    x: Math.random(),
                    y: (Math.random() * skew) - 0.2
                  },
                  colors: colors,
                  shapes: ['circle'],
                  gravity: randomInRange(0.4, 0.6),
                  scalar: randomInRange(0.4, 1),
                  drift: randomInRange(-0.4, 0.4)
                });

                if (timeLeft > 0) {
                  requestAnimationFrame(frame);
                }
              }());
          };

          const handleGoHome = () => {
              setIsWishLaunched(false);
              if (sceneRef.current && launchedStarsRef.current) {
                sceneRef.current.remove(launchedStarsRef.current);
                launchedStarsRef.current = null;
              }
              if (starFieldRef.current) {
                  gsap.to(starFieldRef.current.material, { opacity: 0.8, duration: 1 });
              }
              objectsRef.current.forEach(obj => {
                  gsap.killTweensOf(obj.position);
                  gsap.to(obj.position, { x: obj.userData.initialPosition.x, y: obj.userData.initialPosition.y, z: obj.userData.initialPosition.z, duration: 1, ease: 'power2.out' });
                  
                  if (obj.isGroup) {
                    obj.children.forEach(child => {
                        if (child.material) {
                            gsap.killTweensOf(child.material);
                            gsap.to(child.material, { opacity: 1, duration: 1 });
                        }
                    });
                  } else {
                     gsap.killTweensOf(obj.material);
                     gsap.to(obj.material, { opacity: 1, duration: 1 });
                  }
              });
              goToStep(1);
          };

          useEffect(() => {
              const galleryWrapper = document.getElementById('photo-gallery-wrapper'); if (!galleryWrapper) return;
              const gallery = galleryWrapper.querySelector('.photo-gallery'); const polaroids = galleryWrapper.querySelectorAll('.polaroid'); if (!gallery || !polaroids) return;
              const onMove = (e) => { const rect = galleryWrapper.getBoundingClientRect(); const x = e.clientX - rect.left, y = e.clientY - rect.top; gsap.to(polaroids, { rotateX: gsap.utils.mapRange(0, rect.height, 10, -10, y), rotateY: gsap.utils.mapRange(0, rect.width, -10, 10, x), duration: 0.5, ease: 'power1.out' }); };
              const onLeave = () => gsap.to(polaroids, { rotateX: 0, rotateY: 0, duration: 0.5, ease: 'power1.out' });
              const onWheel = (e) => { if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) return; e.preventDefault(); gallery.scrollLeft += e.deltaY; };
              galleryWrapper.addEventListener('mousemove', onMove); galleryWrapper.addEventListener('mouseleave', onLeave); gallery.addEventListener('wheel', onWheel, { passive: false });
              return () => { galleryWrapper.removeEventListener('mousemove', onMove); galleryWrapper.removeEventListener('mouseleave', onLeave); gallery.removeEventListener('wheel', onWheel); };
          }, [currentStep]);

          const cardStyles = "step absolute inset-0 m-auto w-full card p-6 md:p-8 flex flex-col items-center justify-start gap-4 text-center max-h-[90vh] overflow-y-auto pt-20 pb-8";

          const VideoPlayer = ({ video }) => {
              if (video.type === 'data') {
                  return <div className="aspect-video-container bg-black rounded-lg overflow-hidden shadow-lg"><video src={video.url} controls className="w-full h-full" /></div>;
              }
              const embedUrl = video.type === 'youtube'
                  ? `https://www.youtube.com/embed/${video.id}`
                  : `https://drive.google.com/file/d/${video.id}/preview`;
              return <div className="aspect-video-container bg-black rounded-lg overflow-hidden shadow-lg"><iframe src={embedUrl} frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen title={video.caption}></iframe></div>;
          };

          return (
              <div className="w-full h-screen overflow-hidden">
                  <div id="aurora-bg"><div className="aurora-blur aurora-1"></div><div className="aurora-blur aurora-2"></div><div className="aurora-blur aurora-3"></div><div className="aurora-blur aurora-4"></div></div>
                  <canvas ref={canvasRef} id="three-canvas" className="fixed top-0 left-0 w-full h-full -z-10"></canvas>
                  <main className="relative z-10 w-full h-screen flex flex-col items-center justify-center p-4">
                      <div className="fixed top-5 w-11/12 max-w-md h-2.5 rounded-full p-0.5 bg-slate-900/30 backdrop-blur-sm"><div className="h-1.5 rounded-full bg-gradient-to-r from-pink-500 to-red-500 transition-all duration-500" style={{ width: `${((currentStep - 1) / (TOTAL_STEPS - 1)) * 100}%` }}></div></div>
                      <div className="fixed top-12 left-5 z-20 flex gap-2">
                          <button onClick={handleGoHome} title="Home" className="w-12 h-12 rounded-full flex items-center justify-center text-white bg-slate-800/70 backdrop-blur-sm border border-slate-600 hover:bg-slate-700/70 transition-colors"><i className="fas fa-home"></i></button>
                          <button onClick={onStartOver} title="Edit This Wish" className="w-12 h-12 rounded-full flex items-center justify-center text-white bg-slate-800/70 backdrop-blur-sm border border-slate-600 hover:bg-slate-700/70 transition-colors"><i className="fas fa-edit"></i></button>
                      </div>
                      <button onClick={toggleMusic} title="Toggle Music" className="fixed top-12 right-5 z-20 w-12 h-12 rounded-full flex items-center justify-center text-white bg-slate-800/70 backdrop-blur-sm border border-slate-600 hover:bg-slate-700/70 transition-colors">
                          <i className={`fas ${isMusicPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                      </button>
                      <div className="relative w-full max-w-2xl h-full flex items-center justify-center">
                          <div id="step-1" className={cardStyles} style={{ display: currentStep === 1 ? 'flex' : 'none', justifyContent: 'center' }}><div className="text-7xl animate-pulse">â¤ï¸</div><h1 className="text-5xl font-display text-gradient">Hey {config.recipientName},</h1><p>{config.welcomeMessage}</p><button onClick={handleBegin} className="btn-primary rounded-full px-8 py-3 font-bold mt-4">Let's Begin</button></div>
                          <div id="step-2" className={cardStyles} style={{ display: currentStep === 2 ? 'flex' : 'none', justifyContent: 'center' }}><div className="text-7xl">ðŸŽ‰</div><h1 className="text-5xl font-display text-gradient">Happy Birthday!</h1><p>{config.birthdayMessage}</p><button onClick={() => goToStep(3)} className="btn-primary rounded-full px-8 py-3 font-bold mt-4">There's more...</button></div>
                          <div id="step-3" className={cardStyles} style={{ display: currentStep === 3 ? 'flex' : 'none' }}>
                              <h2 className="text-4xl font-display text-gradient text-center">A Few Things I Adore About You</h2>
                              <div className="bento-grid w-full mt-4">
                                  {(config.bentoItems || []).map((item, i) => {
                                      const totalItems = (config.bentoItems || []).length; const isLastOnOdd = totalItems % 2 !== 0 && i === totalItems - 1;
                                      return (<div key={item.title} className={`bento-item ${isLastOnOdd ? 'col-span-2' : ''}`}>
                                          <h3 className="font-bold text-lg text-white mb-2">{item.icon} {item.title}</h3><p className="text-sm opacity-80">{item.text}</p>
                                      </div>);
                                  })}
                              </div>
                              <button onClick={() => goToStep(4)} className="btn-primary rounded-full px-8 py-3 font-bold mt-6 self-center">Remember this?</button>
                          </div>
                          <div id="step-4" className={cardStyles} style={{ display: currentStep === 4 ? 'flex' : 'none' }}>
                              <h2 className="text-4xl font-display text-gradient text-center">{config.galleryTitle}</h2>
                              <div id="photo-gallery-wrapper" className="w-full relative"><div className="photo-gallery flex gap-8 overflow-x-auto p-4 snap-x snap-mandatory scroll-smooth">{(config.photos || []).map((photo, i) => <figure key={i} className={`polaroid w-64 h-auto flex-shrink-0 snap-center`} style={{transform: `rotate(${(i%2===0? -1:1) * (2+i)}deg)`}}><img src={photo.url} alt={photo.caption} className="w-full h-auto object-cover" /><figcaption className="font-display">{photo.caption}</figcaption></figure>)}</div></div>
                              <p className="text-center italic mt-4">{config.galleryClosing}</p>
                              <button onClick={() => goToStep(5)} className="btn-primary rounded-full px-8 py-3 font-bold mt-4">Some messages for you...</button>
                          </div>
                          <div id="step-5" className={cardStyles} style={{ display: currentStep === 5 ? 'flex' : 'none' }}>
                                <h2 className="text-4xl font-display text-gradient text-center">Some Special Messages</h2>
                                <div className="w-full flex gap-8 overflow-x-auto p-4 snap-x snap-mandatory scroll-smooth">
                                    {(config.videos || []).map((video, i) => (
                                        <div key={i} className="flex-shrink-0 snap-center w-full max-w-lg">
                                            <VideoPlayer video={video} />
                                            <p className="text-center italic mt-2">{video.caption}</p>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => goToStep(6)} className="btn-primary rounded-full px-8 py-3 font-bold mt-4">A soundtrack for you</button>
                            </div>
                            <div id="step-6" className={cardStyles} style={{ display: currentStep === 6 ? 'flex' : 'none' }}>
                                <h2 className="text-4xl font-display text-gradient text-center">A Soundtrack For You</h2>
                                <div className="w-full max-w-md mx-auto mt-4 space-y-2">
                                    {(config.playlist || []).map((song, index) => (
                                        <div key={index} className="flex items-center justify-between gap-4 bg-slate-800/50 p-3 rounded-lg">
                                            <div className="flex items-center gap-3">
                                                <i className="fas fa-music text-pink-400"></i>
                                                <span className="text-left">{song.title}</span>
                                            </div>
                                            <button onClick={() => handlePlaySong(index)} className="w-10 h-10 flex-shrink-0 rounded-full bg-pink-600 hover:bg-pink-700 flex items-center justify-center text-white transition-transform transform hover:scale-110">
                                                <i className={`fas ${currentSongIndex === index && isMusicPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => goToStep(7)} className="btn-primary rounded-full px-8 py-3 font-bold mt-6 self-center">Read my letter</button>
                            </div>
                           <div id="step-7" className={cardStyles} style={{ display: currentStep === 7 ? 'flex' : 'none' }}>
                              <h2 className="text-4xl font-display text-gradient text-center">A Letter For You</h2>
                              <div className="w-full text-left overflow-y-auto max-h-[50vh] prose prose-invert prose-p:text-slate-300 mt-4 px-4 whitespace-pre-wrap">{config.letter}</div>
                              <button onClick={() => goToStep(8)} className="btn-primary rounded-full px-8 py-3 font-bold mt-6 self-center">One last thing...</button>
                          </div>
                          <div id="step-8" className={cardStyles} style={{ display: currentStep === 8 ? 'flex' : 'none', justifyContent: 'center' }}>
                              <div className="text-7xl">ðŸŽ‚</div>
                              <h1 className="text-5xl font-display text-gradient">My Wish For You</h1>
                              <p>{config.wishMessage}</p>
                              <div className="h-10 mt-4"><h2 className="text-3xl text-gradient font-display">{config.finalMessage}</h2></div>
                              <div className="flex flex-col sm:flex-row gap-4 mt-4">
                                <button onClick={handleCelebration} className="btn-primary rounded-full px-8 py-3 font-bold">ðŸŽ‰ Celebrate! ðŸŽ‰</button>
                                <button onClick={() => goToStep(9)} className="btn-primary rounded-full px-8 py-3 font-bold">Make a Wish</button>
                              </div>
                          </div>
                          <div id="step-9" className={cardStyles} style={{ display: currentStep === 9 ? 'flex' : 'none', justifyContent: 'center' }}>
                              {!isWishLaunched ? (
                                <div id="wish-list-ui" className="w-full max-w-md mx-auto transition-opacity duration-500">
                                  <h2 className="text-4xl font-display text-gradient text-center">One Final Wish...</h2>
                                  <p className="text-slate-400 mt-2 mb-4">{config.wishDescription}</p>
                                  <div className="flex gap-2"><input type="text" value={newWish} onChange={(e) => setNewWish(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleAddWish()} placeholder="What are you wishing for?" className="flex-grow bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-400 focus:ring-2 focus:ring-pink-500"/><button onClick={handleAddWish} className="bg-pink-600 hover:bg-pink-700 text-white font-bold p-3 rounded-lg">+</button></div>
                                  <ul className="mt-4 space-y-2 text-left">{wishes.map((wish, index) => (<li key={index} className="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg"><span>{wish}</span><button onClick={() => handleRemoveWish(index)} className="text-red-400 hover:text-red-300">&times;</button></li>))}</ul>
                                  {wishes.length > 0 && <button onClick={handleCopyWishes} className="mt-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">{copySuccess || 'Copy My Wishes'}</button>}
                                  <button onClick={handleLaunchWish} className="w-full btn-primary rounded-full px-8 py-3 font-bold mt-6 self-center">Make a Wish & Launch!</button>
                                </div>
                               ) : (
                                <div className="text-center">
                                    <h2 id="launched-wish-text" className="text-4xl font-display text-gradient opacity-0" style={{ transform: 'scale(0.5)' }}>{launchedWishText}</h2>
                                    <p id="wish-sent-confirmation" className="mt-4 text-xl opacity-0">Your wish is on its way to the stars...</p>
                                </div>
                               )}
                          </div>
                      </div>
                  </main>
                  <div id="youtube-player-container" className="fixed -z-50 top-[-9999px] left-[-9999px]"><div id="youtube-player"></div></div>
              </div>
          );
      };

      // --- PasswordGate Component ---
      const PasswordGate = ({ onAuthSuccess }) => {
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');

          const handleSubmit = (e) => {
              e.preventDefault();
              if (password === 'thakkudu') {
                  onAuthSuccess();
              } else {
                  setError('Incorrect Password');
                  setPassword('');
              }
          };

          return (
              <div className="min-h-screen w-full flex flex-col items-center justify-center p-4 text-slate-200">
                  <div id="aurora-bg"><div className="aurora-blur aurora-1"></div><div className="aurora-blur aurora-2"></div></div>
                  <form onSubmit={handleSubmit} className="w-full max-w-sm mx-auto card p-8 space-y-6">
                      <div className="text-center"><h1 className="text-3xl font-display text-gradient">Secret NameðŸ˜Ž</h1></div>
                      <div><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-400 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300 shadow-lg" placeholder="???ðŸ§" autoFocus /></div>
                      {error && <div className="bg-red-900/50 text-red-300 p-3 rounded-lg text-center">{error}</div>}
                      <button type="submit" className="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg text-lg">Unlock</button>
                  </form>
              </div>
          );
      };

      // --- App Component ---
      const App = () => {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [config, setConfig] = useState(null);
          const [initialFormData, setInitialFormData] = useState(null);

          useEffect(() => {
              if (!isAuthenticated) return;

              const handleHashChange = () => {
                  const hash = window.location.hash.slice(1);
                  if (hash.startsWith('data=')) {
                      try {
                          const encodedData = hash.substring(5);
                          const base64Decoded = atob(decodeURIComponent(encodedData));
                          const jsonString = decodeURIComponent(escape(base64Decoded));
                          const parsedConfig = JSON.parse(jsonString);
                          setConfig(parsedConfig);
                      } catch (e) {
                          console.error("Failed to parse config from URL hash", e);
                          window.location.hash = '';
                          setConfig(null);
                      }
                  } else {
                      setConfig(null);
                  }
              };

              handleHashChange();
              window.addEventListener('hashchange', handleHashChange);
              return () => window.removeEventListener('hashchange', handleHashChange);
          }, [isAuthenticated]);

          const handleCreate = (newConfig) => {
              try {
                  const jsonString = JSON.stringify(newConfig);
                  const safeStringForBtoA = unescape(encodeURIComponent(jsonString));
                  const encodedData = btoa(safeStringForBtoA);
                  window.location.hash = `data=${encodeURIComponent(encodedData)}`;
                  setInitialFormData(null);
              } catch (e) {
                  console.error("Error creating shareable link:", e);
              }
          };

          const handleStartOver = () => {
              setInitialFormData(config);
              window.location.hash = '';
          };

          const handleAuthSuccess = () => {
              setIsAuthenticated(true);
          };

          if (!isAuthenticated) {
              return <PasswordGate onAuthSuccess={handleAuthSuccess} />;
          }

          if (config) {
              return <BirthdayWebsite config={config} onStartOver={handleStartOver} />;
          }
          return (
              <div className="w-full min-h-screen bg-[#0c0a09]">
                  <SetupForm onSubmit={handleCreate} initialData={initialFormData} />
              </div>
          );
      };

      // --- React DOM Render ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
          throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(
          <React.StrictMode>
              <App />
          </React.StrictMode>
      );
    </script>
  </body>
</html>